<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="order">
    <!-- order set으로부터 배송지 정보(연락처, 배송지 주소) 조회 -->
    <select id="getOrderInfo" parameterType="Long" resultType="orderInfoDto">
        SELECT order_address AS orderAddress, order_time AS orderTime, order_phone_number AS orderPhoneNumber
        FROM order_set AS os
        WHERE os.order_set_id = #{orderSetId}
    </select>

    <!-- 한 사용자의 모든 order_detail의 가격 합 -->
    <select id="getConsumerTotalBuyPrice" parameterType="Long" resultType="Long">
        SELECT SUM(buy_price)
        FROM order_detail AS od
            JOIN order_set AS os ON os.order_set_id = od.order_set_id
        WHERE od.status_id NOT IN (7, 11) AND os.consumer_id = #{consumerId}
    </select>

    <!-- [{상품명, 수량 (group by), 구매 시점 가격, 상태}]-->
    <select id="getOrderDetailList" parameterType="Long" resultType="orderDetailDto">
        SELECT i.item_name AS itemName, od.buy_price AS buyPrice, COUNT(*) AS itemQuantity, s.status_name AS statusName
        FROM order_detail AS od
            JOIN cargo AS c ON c.cargo_id = od.cargo_id
            JOIN item AS i ON i.item_id = c.item_id
            JOIN status AS s ON od.status_id = s.status_id
        WHERE od.order_set_id = #{orderSetId}
        GROUP BY c.item_id, buy_price, s.status_name;
    </select>
</mapper>






